# å¼€å‘æŒ‡å¯¼

## ğŸ“‘ ç›®å½•å¤§çº²

### ä¸€ã€é¡¹ç›®æ¦‚è¿°
- [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
- [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
- [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)

### äºŒã€ç¯å¢ƒé…ç½®
- [API Token é…ç½®](#api-token-é…ç½®)
- [ç¯å¢ƒåˆå§‹åŒ–](#ç¯å¢ƒåˆå§‹åŒ–)

### ä¸‰ã€å¼€å‘å‘½ä»¤
- [å¼€å‘æœåŠ¡](#å¼€å‘æœåŠ¡)
- [æ•°æ®åŒæ­¥](#æ•°æ®åŒæ­¥)
- [æ„å»ºéƒ¨ç½²](#æ„å»ºéƒ¨ç½²)

### å››ã€åŒæ­¥è„šæœ¬
- [KV åŒæ­¥è„šæœ¬](#kv-åŒæ­¥è„šæœ¬)
- [D1 åŒæ­¥è„šæœ¬](#d1-åŒæ­¥è„šæœ¬)
- [Schema æ•°æ®åŒæ­¥](#schema-æ•°æ®åŒæ­¥)

### äº”ã€åç«¯è®¾è®¡
- [æƒé™ç³»ç»Ÿæ¶æ„](#æƒé™ç³»ç»Ÿæ¶æ„)
- [æ•°æ®å­˜å‚¨è®¾è®¡](#æ•°æ®å­˜å‚¨è®¾è®¡)
- [æ¥å£ç¼“å­˜æœºåˆ¶](#æ¥å£ç¼“å­˜æœºåˆ¶)

### å…­ã€å‰ç«¯è®¾è®¡
- [è·¯ç”±ç»“æ„](#è·¯ç”±ç»“æ„)
- [çŠ¶æ€ç®¡ç†](#çŠ¶æ€ç®¡ç†)
- [æƒé™æ§åˆ¶](#æƒé™æ§åˆ¶)

### ä¸ƒã€API æ¥å£
- [è®¤è¯æˆæƒ](#è®¤è¯æˆæƒ)
- [ç³»ç»Ÿç®¡ç†](#ç³»ç»Ÿç®¡ç†)
- [å­˜å‚¨ç®¡ç†](#å­˜å‚¨ç®¡ç†)
- [OAuth 2.0](#oauth-20)

---

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

### æŠ€æœ¯æ ˆ

| ç±»å‹ | æŠ€æœ¯ | ç‰ˆæœ¬ |
|------|------|------|
| **åç«¯æ¡†æ¶** | Hono | 4.11.1 |
| **è¿è¡Œå¹³å°** | Cloudflare Workers | - |
| **å‰ç«¯æ¡†æ¶** | React | 19.2.1 |
| **å¼€å‘è¯­è¨€** | TypeScript | 5.8.3 |
| **æ„å»ºå·¥å…·** | Vite | 6.0.0 |
| **UI ç»„ä»¶** | Ant Design | 6.1.3 |
| **æ•°æ®åº“** | D1 (SQLite) | - |
| **KV å­˜å‚¨** | Cloudflare Workers KV | - |
| **å¯¹è±¡å­˜å‚¨** | Cloudflare R2 | - |
| **å·¥å…·åº“** | ExcelJS, Zod, Crypto-JS, React Icons | - |

### é¡¹ç›®ç»“æ„

```
sq-station/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ worker/              # åç«¯ä»£ç 
â”‚   â”‚   â”œâ”€â”€ controllers/     # æ§åˆ¶å™¨å±‚ï¼ˆå¤„ç†è¯·æ±‚ï¼‰
â”‚   â”‚   â”œâ”€â”€ services/        # æœåŠ¡å±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
â”‚   â”‚   â”œâ”€â”€ repositories/    # æ•°æ®è®¿é—®å±‚
â”‚   â”‚   â”œâ”€â”€ middleware/      # ä¸­é—´ä»¶ï¼ˆè®¤è¯ã€æƒé™ã€ç¼“å­˜ï¼‰
â”‚   â”‚   â”œâ”€â”€ dto/            # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”‚   â”œâ”€â”€ constants/      # å¸¸é‡å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ utils/          # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ config/         # é…ç½®æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ index.ts        # åº”ç”¨å…¥å£
â”‚   â”‚
â”‚   â””â”€â”€ react-app/           # å‰ç«¯ä»£ç 
â”‚       â”œâ”€â”€ pages/          # é¡µé¢ç»„ä»¶
â”‚       â”‚   â”œâ”€â”€ dashboard/  # åå°ç®¡ç†é¡µé¢
â”‚       â”‚   â”œâ”€â”€ system/     # ç³»ç»Ÿç®¡ç†é¡µé¢
â”‚       â”‚   â””â”€â”€ frontend/   # å‰å°é¡µé¢
â”‚       â”œâ”€â”€ hooks/          # React Hooks
â”‚       â”œâ”€â”€ services/       # API æœåŠ¡
â”‚       â”œâ”€â”€ utils/          # å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ config/         # é…ç½®æ–‡ä»¶
â”‚       â””â”€â”€ types/          # TypeScript ç±»å‹
â”‚
â”œâ”€â”€ scripts/                # åŒæ­¥è„šæœ¬
â”‚   â”œâ”€â”€ sync-kv.cjs        # KV æ•°æ®åŒæ­¥
â”‚   â”œâ”€â”€ sync-d1.cjs        # D1 æ•°æ®åŒæ­¥
â”‚   â”œâ”€â”€ sync-schema-data.cjs  # Schema æ•°æ®åŒæ­¥
â”‚   â””â”€â”€ shared/            # å…±äº«æ¨¡å—
â”‚
â”œâ”€â”€ sql/                   # æ•°æ®åº“ç›¸å…³
â”‚   â”œâ”€â”€ schema.sql         # æ•°æ®åº“ç»“æ„
â”‚   â”œâ”€â”€ schema-data.json   # åˆå§‹æ•°æ®
â”‚   â””â”€â”€ kv-schema.json     # KV æ•°æ®å®šä¹‰
â”‚
â”œâ”€â”€ doc/                   # é¡¹ç›®æ–‡æ¡£
â””â”€â”€ wrangler.json         # Cloudflare é…ç½®
```

### æ ¸å¿ƒåŠŸèƒ½

| æ¨¡å— | åŠŸèƒ½è¯´æ˜ |
|------|---------|
| **è®¤è¯æˆæƒ** | JWT è®¤è¯ã€RBAC æƒé™æ§åˆ¶ã€èœå•æƒé™ |
| **ç”¨æˆ·ç®¡ç†** | ç”¨æˆ· CRUDã€è§’è‰²åˆ†é…ã€ç»„ç»‡å½’å± |
| **è§’è‰²ç®¡ç†** | è§’è‰² CRUDã€èœå•æƒé™åˆ†é… |
| **èœå•ç®¡ç†** | èœå•æ ‘ç®¡ç†ã€è·¯ç”±é…ç½® |
| **ç»„ç»‡ç®¡ç†** | ç»„ç»‡æ¶æ„ç®¡ç†ã€æ•°æ®æƒé™ |
| **OAuth 2.0** | Client Credentialsã€å®¢æˆ·ç«¯ç®¡ç†ã€æƒé™ç»„ç®¡ç† |
| **KV å­˜å‚¨** | é”®å€¼å¯¹ç®¡ç†ã€Schema ç‰ˆæœ¬æ§åˆ¶ |
| **R2 å­˜å‚¨** | æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ã€æ–‡ä»¶å¤¹ç®¡ç† |
| **ä¹¦ç­¾ç®¡ç†** | å‰å°å¯¼èˆªé…ç½® |
| **SQL å·¥å…·** | åœ¨çº¿ SQL æ‰§è¡Œ |

---

## äºŒã€ç¯å¢ƒé…ç½®

### API Token é…ç½®

é¡¹ç›®å·²æ”¯æŒé€šè¿‡ `.dev.vars` æ–‡ä»¶é…ç½® Cloudflare API Tokenï¼Œæ— éœ€æ‰‹åŠ¨ç™»å½•å³å¯æ‰§è¡Œè¿œç¨‹å‘½ä»¤ã€‚

#### é…ç½®æ–¹å¼

1. å¤åˆ¶ç¤ºä¾‹æ–‡ä»¶ï¼š
```bash
cp .dev.vars.example .dev.vars
```

2. ç¼–è¾‘ `.dev.vars` æ–‡ä»¶ï¼Œå°† Token æ›¿æ¢ä¸ºä½ çš„å®é™…å€¼ï¼š
```bash
CLOUDFLARE_API_TOKEN=ä½ çš„token
```

**æ³¨æ„**ï¼š`.dev.vars` æ–‡ä»¶å·²æ·»åŠ åˆ° `.gitignore`ï¼Œä¸ä¼šæäº¤åˆ° Gitã€‚

#### è·å– API Token

1. è®¿é—® https://dash.cloudflare.com/profile/api-tokens
2. åˆ›å»º Tokenï¼Œéœ€è¦ä»¥ä¸‹æƒé™ï¼š
   - **Account** â†’ **D1** â†’ **Edit**
   - **Account** â†’ **Workers Scripts** â†’ **Edit**
   - **Account** â†’ **Cloudflare KV** â†’ **Edit**
   - **Account** â†’ **Cloudflare R2** â†’ **Edit**

#### ä½¿ç”¨æ–¹å¼

é…ç½® Token åï¼Œä»¥ä¸‹å‘½ä»¤ä¼šè‡ªåŠ¨ä½¿ç”¨é¡¹ç›®ä¸­çš„ Tokenï¼š
```bash
npm run d1:migrate     # åŒæ­¥ schema åˆ°è¿œç¨‹ D1
npm run d1:query      # æŸ¥è¯¢è¿œç¨‹ D1
npm run kv:export     # å¯¼å‡º KV åˆ°è¿œç¨‹
npm run deploy        # éƒ¨ç½²åˆ° Workers
```

### ç¯å¢ƒåˆå§‹åŒ–

#### worker-configuration.d.ts è¯´æ˜

`worker-configuration.d.ts` æ˜¯ç”± Wrangler è‡ªåŠ¨ç”Ÿæˆçš„ TypeScript ç±»å‹å®šä¹‰æ–‡ä»¶ã€‚

**ä½œç”¨ï¼š**
- ä¸º `wrangler.json` ä¸­é…ç½®çš„æ‰€æœ‰ç»‘å®šï¼ˆKVã€D1ã€R2ï¼‰æä¾› TypeScript ç±»å‹å®šä¹‰
- åœ¨ä»£ç ä¸­è·å¾—å®Œæ•´çš„ç±»å‹æç¤ºå’Œ IntelliSense æ”¯æŒ
- é¿å…æ‹¼å†™é”™è¯¯å’Œç±»å‹ä¸åŒ¹é…çš„é—®é¢˜

**ä½•æ—¶é‡æ–°ç”Ÿæˆï¼š**
- ä¿®æ”¹ `wrangler.json` åï¼ˆæ·»åŠ /åˆ é™¤ç»‘å®šã€ç¯å¢ƒå˜é‡ç­‰ï¼‰
- è¿è¡Œå‘½ä»¤ï¼š`npx wrangler types`

**ç”Ÿæˆçš„ç±»å‹ç¤ºä¾‹ï¼š**
```typescript
interface Env {
  KV_BINDING: KVNamespace;
  R2_BINDING: R2Bucket;
  DB: D1Database;
  JWT_SECRET: string;
  JWT_EXPIRES_IN: string;
}
```

---

## ä¸‰ã€å¼€å‘å‘½ä»¤

### å¼€å‘æœåŠ¡

#### ç¯å¢ƒåˆå§‹åŒ–
```bash
npm run init       # åˆå§‹åŒ–æœ¬åœ°å¼€å‘ç¯å¢ƒ (æ¸…é™¤ç¼“å­˜ + åˆå§‹åŒ–è¡¨ + åŒæ­¥æ•°æ®)
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- åœ¨ `npm install` ä¹‹åé¦–æ¬¡å¯åŠ¨å¼€å‘ç¯å¢ƒ
- æœ¬åœ°æ•°æ®å‡ºç°å¼‚å¸¸éœ€è¦é‡ç½®æ—¶
- éœ€è¦åŒæ­¥æœ€æ–°çš„è¿œç¨‹æ•°æ®æ—¶

**æ‰§è¡Œæµç¨‹**ï¼š
1. æ¸…é™¤æœ¬åœ° KVã€D1ã€R2 ç¼“å­˜
2. åˆå§‹åŒ–æœ¬åœ°æ•°æ®åº“è¡¨
3. åŒæ­¥è¿œç¨‹æ•°æ®åˆ°æœ¬åœ°

#### å¼€å¯æœåŠ¡
```bash
# åŒæœåŠ¡å™¨å¼€å‘æ¨¡å¼ï¼ˆæ¨èï¼šæ”¯æŒå‰ç«¯çƒ­æ›´æ–°ï¼‰
npm run sync        # åŒæ­¥è¿œç¨‹æ•°æ® (KV + D1) åˆ°æœ¬åœ°
npm run dev         # å‰ç«¯å¼€å‘æœåŠ¡å™¨ (Viteï¼Œç«¯å£ 5173ï¼Œæ”¯æŒçƒ­æ›´æ–°)
npm run wrangler    # åç«¯å¼€å‘æœåŠ¡å™¨ (Wranglerï¼Œç«¯å£ 8787) è¿è¡Œæ—¶éœ€è¦å…ˆæ„å»º npm run build éçƒ­æ›´æ–°

# å•æœåŠ¡å™¨å¼€å‘æ¨¡å¼
npm run dev:auto    # è‡ªåŠ¨åŒæ­¥æ•°æ® + å¯åŠ¨ Wrangler (ç«¯å£ 8787ï¼Œæ— çƒ­æ›´æ–°)
npm run dev:remote  # ç›´è¿è¿œç¨‹æ•°æ®å¼€å‘

# æ„å»º/éƒ¨ç½²
npm run build        # TypeScript ç¼–è¯‘ + Vite æ‰“åŒ…
npm run deploy       # éƒ¨ç½²åˆ° Cloudflare Workers
npm run check        # å®Œæ•´æ£€æŸ¥ (TS + æ‰“åŒ… + éƒ¨ç½²é¢„æ¼”)
npm run preview      # æ„å»ºå¹¶é¢„è§ˆ
npm run lint         # ESLint ä»£ç æ£€æŸ¥
npm run cf-typegen   # ç”Ÿæˆ Cloudflare ç±»å‹å®šä¹‰
```

### æ•°æ®åŒæ­¥

#### KV å­˜å‚¨
```bash
# æ•°æ®åŒæ­¥
npm run kv:import    # ä»è¿œç¨‹ KV å¯¼å…¥åˆ°æœ¬åœ°
npm run kv:export    # ä»æœ¬åœ°å¯¼å‡ºåˆ°è¿œç¨‹ KV (è‡ªåŠ¨å¤‡ä»½ï¼Œå­˜æ”¾åœ¨ sql/.backup/kv/)

# Schema é…ç½®ç®¡ç†
npm run kv:migrate:local    # åº”ç”¨æœ¬åœ° kv-schema.json é…ç½®åˆ°æœ¬åœ° KV
npm run kv:migrate          # åº”ç”¨æœ¬åœ° kv-schema.json é…ç½®åˆ°è¿œç¨‹ KV
npm run kv:validate         # éªŒè¯ kv-schema.json é…ç½®æ ¼å¼
npm run kv:remote-to-schema # ä»è¿œç¨‹ KV åŒæ­¥åˆ° kv-schema.json
npm run kv:local-to-schema  # ä»æœ¬åœ° KV åŒæ­¥åˆ° kv-schema.json
```

#### D1 æ•°æ®åº“
```bash
# è¡¨ç»“æ„è¿ç§»ï¼ˆé¦–æ¬¡ä½¿ç”¨å¿…é¡»æ‰§è¡Œï¼‰
npm run d1:migrate       # è¿œç¨‹åˆå§‹åŒ– (æ‰§è¡Œ schema.sql)
npm run d1:migrate:local # æœ¬åœ°åˆå§‹åŒ– (æ‰§è¡Œ schema.sql)

# æ•°æ®åŒæ­¥
npm run d1:export      # æœ¬åœ° -> è¿œç¨‹ (å¯¼å‡ºå‰è‡ªåŠ¨å¤‡ä»½)
npm run d1:import      # è¿œç¨‹ -> æœ¬åœ°

# ä»…å¤‡ä»½
npm run d1:backup:remote  # å¤‡ä»½è¿œç¨‹æ•°æ®åˆ° sql/.backup/d1/
npm run d1:backup:local   # å¤‡ä»½æœ¬åœ°æ•°æ®åˆ° sql/.backup/d1/

# æŸ¥è¯¢
npm run d1:query "SELECT * FROM sys_user"      # æŸ¥è¯¢è¿œç¨‹ D1
npm run d1:query:local "SELECT * FROM sys_user" # æŸ¥è¯¢æœ¬åœ° D1
```

#### Schema æ•°æ®
```bash
# D1 è¡¨æ•°æ®ä¸ schema-data.json åŒå‘åŒæ­¥
npm run schema:remote-to-schema  # è¿œç¨‹ â†’ schema-data.json
npm run schema:local-to-schema   # æœ¬åœ° â†’ schema-data.json
npm run schema:schema-to-remote  # schema-data.json â†’ è¿œç¨‹
npm run schema:schema-to-local   # schema-data.json â†’ æœ¬åœ°
```

### æ„å»ºéƒ¨ç½²

```bash
npm run build        # TypeScript ç¼–è¯‘ + Vite æ‰“åŒ…
npm run deploy       # éƒ¨ç½²åˆ° Cloudflare Workers
npm run check        # å®Œæ•´æ£€æŸ¥ (TS + æ‰“åŒ… + éƒ¨ç½²é¢„æ¼”)
npm run preview      # æ„å»ºå¹¶é¢„è§ˆ
npm run lint         # ESLint ä»£ç æ£€æŸ¥
```

---

## å››ã€åŒæ­¥è„šæœ¬

### KV åŒæ­¥è„šæœ¬

**è„šæœ¬ä½ç½®**ï¼š`scripts/sync-kv.cjs`

**åŠŸèƒ½**ï¼š
- `import` - ä»è¿œç¨‹ KV å¯¼å…¥åˆ°æœ¬åœ°ç¼“å­˜
- `export` - ä»æœ¬åœ°å¯¼å‡ºåˆ°è¿œç¨‹ KVï¼ˆå¯¼å‡ºå‰è‡ªåŠ¨å¤‡ä»½ï¼‰
- `migrate` / `migrate local` - åº”ç”¨ kv-schema.json åˆ°è¿œç¨‹/æœ¬åœ° KV
- `validate` - éªŒè¯ kv-schema.json æ–‡ä»¶æ ¼å¼
- `to-schema remote` / `to-schema local` - ä»è¿œç¨‹/æœ¬åœ° KV åŒæ­¥åˆ° kv-schema.json

**å¤‡ä»½ä½ç½®**ï¼š`sql/.backup/kv/`

**KV Schema é…ç½®**ï¼š

é¡¹ç›®ä½¿ç”¨ `kv-schema.json` æ–‡ä»¶å®šä¹‰ KV å­˜å‚¨çš„æ•°æ®ç»“æ„ï¼Œå®ç°å‰ç«¯é…ç½®çš„ç‰ˆæœ¬åŒ–ç®¡ç†ã€‚

```json
{
  "_comment": "KV å­˜å‚¨æ•°æ®å®šä¹‰æ–‡ä»¶",
  "_version": "1.0.0",
  "namespaces": {
    "frontend": {
      "_comment": "å‰ç«¯é¡µé¢é…ç½®æ•°æ®",
      "data": {
        "bookmarks:config": {
          "value": { ... },
          "type": "json",
          "description": "é¦–é¡µä¹¦ç­¾å¯¼èˆªé…ç½®"
        }
      }
    }
  }
}
```

### D1 åŒæ­¥è„šæœ¬

**è„šæœ¬ä½ç½®**ï¼š`scripts/sync-d1.cjs`

**åŠŸèƒ½**ï¼š
- `import` - ä»è¿œç¨‹ D1 å¯¼å…¥æ•°æ®åˆ°æœ¬åœ°
- `export` - ä»æœ¬åœ°å¯¼å‡ºæ•°æ®åˆ°è¿œç¨‹ D1ï¼ˆå¯¼å‡ºå‰è‡ªåŠ¨å¤‡ä»½ï¼‰
- `backup:remote` / `backup:local` - å¤‡ä»½è¿œç¨‹/æœ¬åœ°æ•°æ®
- `migrate` / `migrate local` - æ‰§è¡Œ schema.sql åˆå§‹åŒ–è¡¨ç»“æ„

**å¤‡ä»½ä½ç½®**ï¼š`sql/.backup/d1/`

### Schema æ•°æ®åŒæ­¥

**è„šæœ¬ä½ç½®**ï¼š`scripts/sync-schema-data.cjs`

**åŠŸèƒ½**ï¼š
- `remote-to-schema` - è¿œç¨‹ D1 â†’ schema-data.json
- `local-to-schema` - æœ¬åœ° D1 â†’ schema-data.json
- `schema-to-remote` - schema-data.json â†’ è¿œç¨‹ D1
- `schema-to-local` - schema-data.json â†’ æœ¬åœ° D1

**å¤‡ä»½ä½ç½®**ï¼š`sql/.backup/schema-data/`

### å…±äº«æ¨¡å—

**ä½ç½®**ï¼š`scripts/shared/`

**æ¨¡å—**ï¼š
- `utils.cjs` - é€šç”¨å·¥å…·å‡½æ•°ï¼ˆç›®å½•åˆ›å»ºã€æ—¶é—´æˆ³ç”Ÿæˆï¼‰
- `wrangler.cjs` - Wrangler å‘½ä»¤å°è£…ï¼ˆKVHelperã€D1Helperï¼‰

---

## äº”ã€åç«¯è®¾è®¡

### æƒé™ç³»ç»Ÿæ¶æ„

é¡¹ç›®é‡‡ç”¨ç»Ÿä¸€çš„æƒé™å¸¸é‡ç®¡ç†ï¼Œæ‰€æœ‰æƒé™å®šä¹‰ä½äº `src/worker/constants/permissions.ts`ã€‚

**æƒé™å‘½åè§„èŒƒ**ï¼š`æ¨¡å—:å­æ¨¡å—:æ“ä½œ`ï¼ˆå¦‚ `system:user:read`ï¼‰

**æ”¯æŒ 7 å¤§åŠŸèƒ½æ¨¡å—**ï¼š

| æ¨¡å— | è¯´æ˜ | æƒé™æ•°é‡ |
|------|------|---------|
| ç³»ç»Ÿç®¡ç† | ç”¨æˆ·ã€è§’è‰²ã€èœå•ã€ç»„ç»‡ã€SQL æŸ¥è¯¢ | 24 |
| OAuth | å®¢æˆ·ç«¯ç®¡ç†ã€æƒé™ç»„ç®¡ç† | 10 |
| R2 | æ–‡ä»¶ç®¡ç†ã€æ–‡ä»¶å¤¹ç®¡ç† | 6 |
| å†…å®¹ç®¡ç† | æ–‡ç« ã€åˆ†ç±»ï¼ˆé¢„ç•™ï¼‰ | 8 |
| å‰å°é…ç½® | Bookmarks ç®¡ç† | 4 |
| ç”¨æˆ·ä¸­å¿ƒ | ä¸ªäººä¿¡æ¯ã€å¯†ç ã€é€šçŸ¥ï¼ˆé¢„ç•™ï¼‰ | 5 |
| ä»ªè¡¨ç›˜ | æ•°æ®æŸ¥çœ‹ï¼ˆé¢„ç•™ï¼‰ | 2 |

**è¶…çº§ç®¡ç†å‘˜æƒé™**ï¼š`*:*:*` - æ‹¥æœ‰æ‰€æœ‰æƒé™

**æƒé™é€šé…ç¬¦åŒ¹é…**ï¼šæ”¯æŒ `system:user:*` æ ¼å¼çš„é€šé…ç¬¦æƒé™

### æ•°æ®å­˜å‚¨è®¾è®¡

#### D1 æ•°æ®åº“

**è¡¨ç»“æ„**ï¼š
- `sys_user` - ç”¨æˆ·è¡¨
- `sys_role` - è§’è‰²è¡¨
- `sys_menu` - èœå•è¡¨
- `sys_organization` - ç»„ç»‡è¡¨
- `sys_user_role` - ç”¨æˆ·è§’è‰²å…³è”è¡¨
- `sys_role_menu` - è§’è‰²èœå•å…³è”è¡¨
- `sys_user_organization` - ç”¨æˆ·ç»„ç»‡å…³è”è¡¨
- `sys_oauth_client` - OAuth å®¢æˆ·ç«¯è¡¨
- `sys_oauth_permission_group` - OAuth æƒé™ç»„è¡¨

**Schema æ–‡ä»¶**ï¼š`sql/schema.sql`

#### KV å­˜å‚¨

**å‘½åç©ºé—´**ï¼š
- `frontend` - å‰ç«¯é¡µé¢é…ç½®æ•°æ®

**æ•°æ®å®šä¹‰**ï¼š`sql/kv-schema.json`

#### R2 å¯¹è±¡å­˜å‚¨

**å­˜å‚¨æ¡¶**ï¼šé…ç½®åœ¨ `wrangler.json` ä¸­

**åŠŸèƒ½**ï¼š
- æ–‡ä»¶ä¸Šä¼ /ä¸‹è½½
- æ–‡ä»¶å¤¹ç®¡ç†ï¼ˆåˆ›å»ºã€åˆ é™¤ã€åˆ—è¡¨ï¼‰
- å…ƒæ•°æ®ç®¡ç†

### æ¥å£ç¼“å­˜æœºåˆ¶

é¡¹ç›®å®ç°äº† GET è¯·æ±‚çš„æ¥å£ç¼“å­˜åŠŸèƒ½ï¼Œå¯ä»¥æœ‰æ•ˆå‡å°‘æ•°æ®åº“æŸ¥è¯¢ï¼Œæé«˜å“åº”é€Ÿåº¦ã€‚

**ç¼“å­˜é…ç½®**ï¼š`src/worker/config/app.config.ts`

```typescript
cache: {
  enabled: true,           // æ˜¯å¦å¯ç”¨ç¼“å­˜
  defaultTTL: 2000,       // é»˜è®¤ç¼“å­˜æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  excludeRoutes: [         // æ’é™¤çš„è·¯ç”±ï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰
    "/api/r2/*",          // æ’é™¤æ‰€æœ‰ R2 æ¥å£
    "/api/kv/*",          // æ’é™¤æ‰€æœ‰ KV æ¥å£
  ],
}
```

**ç¼“å­˜ç®¡ç†æ¥å£**ï¼š

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | `/api/cache/stats` | æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯ |
| GET | `/api/cache/test` | æµ‹è¯•ç¼“å­˜æ˜¯å¦ç”Ÿæ•ˆ |
| POST | `/api/cache/clear` | æ¸…é™¤æ‰€æœ‰ç¼“å­˜ |

---

## å…­ã€å‰ç«¯è®¾è®¡

### è·¯ç”±ç»“æ„

| è·¯å¾„ | é¡µé¢ | è¯´æ˜ |
|------|------|------|
| `/` | Home | å‰å°é¦–é¡µ |
| `/login` | Login | ç™»å½•é¡µ |
| `/dashboard/home` | Home | ä»ªè¡¨ç›˜é¦–é¡µ |
| `/dashboard/system/user` | UserManage | ç”¨æˆ·ç®¡ç† |
| `/dashboard/system/role` | RoleManage | è§’è‰²ç®¡ç† |
| `/dashboard/system/menu` | MenuManage | èœå•ç®¡ç† |
| `/dashboard/system/organization` | OrganizationManage | ç»„ç»‡ç®¡ç† |
| `/dashboard/system/kv` | KVManage | KV ç®¡ç† |
| `/dashboard/system/r2` | R2Manage | R2 å¯¹è±¡å­˜å‚¨ç®¡ç† |
| `/dashboard/system/oauth` | OAuthClientManage | OAuth å®¢æˆ·ç«¯ç®¡ç† |
| `/dashboard/system/oauth-groups` | OAuthPermissionGroupManage | æƒé™ç»„ç®¡ç† |
| `/dashboard/system/sql` | SQLSearch | SQL æ‰§è¡Œå·¥å…· |
| `/dashboard/frontend/bookmarks` | BookmarksManage | ä¹¦ç­¾ç®¡ç† |

### çŠ¶æ€ç®¡ç†

é¡¹ç›®ä½¿ç”¨ React Hooks è¿›è¡ŒçŠ¶æ€ç®¡ç†ï¼Œä¸»è¦ Hooksï¼š

| Hook | ç”¨é€” | ä½ç½® |
|------|------|------|
| `useAsyncData` | å¼‚æ­¥æ•°æ®è·å– | `src/react-app/hooks/` |
| `usePermission` | æƒé™æ£€æŸ¥ | `src/react-app/hooks/` |
| `useTable` | è¡¨æ ¼çŠ¶æ€ç®¡ç† | `src/react-app/hooks/` |
| `useForm` | è¡¨å•çŠ¶æ€ç®¡ç† | `src/react-app/hooks/` |
| `useModal` | å¼¹çª—çŠ¶æ€ç®¡ç† | `src/react-app/hooks/` |
| `useConfirm` | ç¡®è®¤æ¡†çŠ¶æ€ç®¡ç† | `src/react-app/hooks/` |

### æƒé™æ§åˆ¶

å‰ç«¯æƒé™æ§åˆ¶åŸºäºç”¨æˆ·æƒé™åˆ—è¡¨ï¼š

**æƒé™å·¥å…·**ï¼š`src/react-app/utils/auth/permission.ts`

**ä¸»è¦åŠŸèƒ½**ï¼š
- `hasPermission()` - æ£€æŸ¥æ˜¯å¦æœ‰æŒ‡å®šæƒé™
- `hasAnyPermission()` - æ£€æŸ¥æ˜¯å¦æœ‰ä»»æ„ä¸€ä¸ªæƒé™
- `hasAllPermissions()` - æ£€æŸ¥æ˜¯å¦æœ‰æ‰€æœ‰æƒé™

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```typescript
import { hasPermission } from '@/utils/auth/permission';

// æ£€æŸ¥æƒé™
if (hasPermission('system:user:delete')) {
  // æœ‰åˆ é™¤æƒé™
}
```

---

## ä¸ƒã€API æ¥å£

### è®¤è¯æˆæƒ

#### ç™»å½•æ¥å£

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| POST | `/api/auth/login` | ç”¨æˆ·ç™»å½• |
| POST | `/api/auth/logout` | ç”¨æˆ·ç™»å‡º |
| GET | `/api/auth/me` | è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ |

#### æƒé™éªŒè¯

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | `/api/user/:id/menus` | è·å–ç”¨æˆ·å¯è®¿é—®èœå• |
| GET | `/api/user/:id/permissions` | è·å–ç”¨æˆ·æƒé™åˆ—è¡¨ |

### ç³»ç»Ÿç®¡ç†

#### ç”¨æˆ·ç®¡ç†

| æ–¹æ³• | è·¯å¾„ | æƒé™ | è¯´æ˜ |
|------|------|------|------|
| GET | `/api/users` | `system:user:list` | è·å–ç”¨æˆ·åˆ—è¡¨ |
| GET | `/api/users/:id` | `system:user:read` | è·å–å•ä¸ªç”¨æˆ· |
| POST | `/api/users` | `system:user:add` | åˆ›å»ºç”¨æˆ· |
| PUT | `/api/users/:id` | `system:user:edit` | æ›´æ–°ç”¨æˆ· |
| DELETE | `/api/users/:id` | `system:user:delete` | åˆ é™¤ç”¨æˆ· |
| GET | `/api/users/:id/roles` | `system:user:assignRole` | è·å–ç”¨æˆ·è§’è‰² |
| PUT | `/api/users/:id/roles` | `system:user:assignRole` | åˆ†é…è§’è‰² |

#### è§’è‰²ç®¡ç†

| æ–¹æ³• | è·¯å¾„ | æƒé™ | è¯´æ˜ |
|------|------|------|------|
| GET | `/api/roles` | `system:role:list` | è·å–è§’è‰²åˆ—è¡¨ |
| GET | `/api/roles/:id` | `system:role:read` | è·å–å•ä¸ªè§’è‰² |
| POST | `/api/roles` | `system:role:add` | åˆ›å»ºè§’è‰² |
| PUT | `/api/roles/:id` | `system:role:edit` | æ›´æ–°è§’è‰² |
| DELETE | `/api/roles/:id` | `system:role:delete` | åˆ é™¤è§’è‰² |
| GET | `/api/roles/:id/menus` | `system:role:assignMenu` | è·å–è§’è‰²èœå• |
| PUT | `/api/roles/:id/menus` | `system:role:assignMenu` | åˆ†é…èœå• |

#### èœå•ç®¡ç†

| æ–¹æ³• | è·¯å¾„ | æƒé™ | è¯´æ˜ |
|------|------|------|------|
| GET | `/api/menus` | `system:menu:list` | è·å–èœå•æ ‘ |
| GET | `/api/menus/:id` | `system:menu:read` | è·å–å•ä¸ªèœå• |
| POST | `/api/menus` | `system:menu:add` | åˆ›å»ºèœå• |
| PUT | `/api/menus/:id` | `system:menu:edit` | æ›´æ–°èœå• |
| DELETE | `/api/menus/:id` | `system:menu:delete` | åˆ é™¤èœå• |

#### ç»„ç»‡ç®¡ç†

| æ–¹æ³• | è·¯å¾„ | æƒé™ | è¯´æ˜ |
|------|------|------|------|
| GET | `/api/organizations` | `system:organization:list` | è·å–ç»„ç»‡æ ‘ |
| POST | `/api/organizations` | `system:organization:add` | åˆ›å»ºç»„ç»‡ |
| PUT | `/api/organizations/:id` | `system:organization:edit` | æ›´æ–°ç»„ç»‡ |
| DELETE | `/api/organizations/:id` | `system:organization:delete` | åˆ é™¤ç»„ç»‡ |

#### SQL æ‰§è¡Œå·¥å…·

| æ–¹æ³• | è·¯å¾„ | æƒé™ | è¯´æ˜ |
|------|------|------|------|
| POST | `/api/sql/query` | `system:sql:execute` | æ‰§è¡Œ SQL è¯­å¥ |

### å­˜å‚¨ç®¡ç†

#### KV å­˜å‚¨

| æ–¹æ³• | è·¯å¾„ | æƒé™ | è¯´æ˜ |
|------|------|------|------|
| GET | `/api/kv` | `kv:store:list` | åˆ—å‡ºæ‰€æœ‰ key |
| GET | `/api/kv/:key` | `kv:store:read` | è·å–å•ä¸ªå€¼ |
| PUT | `/api/kv/:key` | `kv:store:write` | è®¾ç½®å€¼ |
| DELETE | `/api/kv/:key` | `kv:store:delete` | åˆ é™¤å€¼ |
| POST | `/api/kv/sync` | `kv:store:sync` | åŒæ­¥æ‰€æœ‰è¿œç¨‹æ•°æ® |

#### R2 å¯¹è±¡å­˜å‚¨

**æ–‡ä»¶ç®¡ç†**ï¼š

| æ–¹æ³• | è·¯å¾„ | æƒé™ | è¯´æ˜ |
|------|------|------|------|
| GET | `/api/r2` | `r2:file:list` | åˆ—å‡ºæ‰€æœ‰å¯¹è±¡ |
| GET | `/api/r2/:key` | `r2:file:view` | è·å–å¯¹è±¡ |
| PUT | `/api/r2/:key` | `r2:file:upload` | ä¸Šä¼ å¯¹è±¡ |
| DELETE | `/api/r2/:key` | `r2:file:delete` | åˆ é™¤å•ä¸ªå¯¹è±¡ |
| POST | `/api/r2/delete` | `r2:file:delete` | æ‰¹é‡åˆ é™¤ |

**æ–‡ä»¶å¤¹ç®¡ç†**ï¼š

| æ–¹æ³• | è·¯å¾„ | æƒé™ | è¯´æ˜ |
|------|------|------|------|
| GET | `/api/r2/folders` | `r2:folder:list` | è·å–æ–‡ä»¶å¤¹åˆ—è¡¨ |
| PUT | `/api/r2/folder/:path` | `r2:folder:create` | åˆ›å»ºæ–‡ä»¶å¤¹ |
| DELETE | `/api/r2/folder/:path` | `r2:folder:delete` | åˆ é™¤æ–‡ä»¶å¤¹ |

#### R2 æ“ä½œåˆ†ç±»

Cloudflare R2 å°†æ“ä½œåˆ†ä¸ºä¸¤ç±»ï¼Œå®šä»·ä¸åŒï¼š

**A ç±»æ“ä½œï¼ˆå†™å…¥/åˆ—ä¸¾ï¼‰**ï¼š
- ListObjects, PutObject, CopyObject, CreateMultipartUpload, UploadPart ç­‰

**B ç±»æ“ä½œï¼ˆè¯»å–ï¼‰**ï¼š
- HeadObject, GetObject, HeadBucket, GetBucketCors ç­‰

**å¼€å‘å»ºè®®**ï¼š
1. å‡å°‘ A ç±»æ“ä½œï¼ˆæˆæœ¬è¾ƒé«˜ï¼‰
2. ä¼˜å…ˆä½¿ç”¨ B ç±»æ“ä½œ
3. æ‰‹åŠ¨è§¦å‘åˆ—è¡¨åŠ è½½ï¼ˆè€Œéè‡ªåŠ¨åŠ è½½ï¼‰

### å‰å°é…ç½®

#### Bookmarks æ¥å£

| æ–¹æ³• | è·¯å¾„ | æƒé™ | è¯´æ˜ |
|------|------|------|------|
| GET | `/api/bookmarks/config` | `frontend:bookmarks:read` | è·å–ä¹¦ç­¾é…ç½® |
| PUT | `/api/bookmarks/config` | `frontend:bookmarks:update` | æ›´æ–°ä¹¦ç­¾é…ç½® |

**é…ç½®æ•°æ®ç»“æ„**ï¼š
```json
{
  "åˆ†ç±»å": {
    "desc": "åˆ†ç±»æè¿°",
    "order": 1,
    "items": [
      {
        "content": "æ ‡é¢˜",
        "summary": "æ‘˜è¦",
        "url": "é“¾æ¥",
        "desc": "æè¿°",
        "newWindow": true,
        "orderM": 1
      }
    ]
  }
}
```

### OAuth 2.0

é¡¹ç›®å®ç°äº† OAuth 2.0 Client Credentials æˆæƒæµç¨‹ï¼Œå…è®¸å¤–éƒ¨ç³»ç»Ÿé€šè¿‡è·å– Access Token æ¥è®¿é—®å—ä¿æŠ¤çš„ API èµ„æºã€‚

**æ ¸å¿ƒè®¾è®¡**ï¼šOAuth å®¢æˆ·ç«¯é€šè¿‡ç»‘å®š**æƒé™ç»„**æ¥è·å¾—è®¿é—®æƒé™ï¼Œæƒé™å®Œå…¨ç”±æƒé™ç»„å†³å®šï¼Œæ”¯æŒåŠ¨æ€ç®¡ç†ã€‚

#### è·å– Access Token

**è¯·æ±‚ç«¯ç‚¹**ï¼š`POST /oauth/token`

**è¯·æ±‚ä½“**ï¼š
```json
{
  "grant_type": "client_credentials",
  "client_id": "client_xxxxxxxxxxxxxxxxxxxxxxx",
  "client_secret": "cs_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
}
```

**å“åº”**ï¼š
```json
{
  "code": 200,
  "data": {
    "access_token": "eyJhbGc...",
    "token_type": "Bearer",
    "expires_in": 3600
  }
}
```

#### OAuth å®¢æˆ·ç«¯ç®¡ç†

| æ–¹æ³• | è·¯å¾„ | æƒé™ | è¯´æ˜ |
|------|------|------|------|
| GET | `/api/oauth/clients` | `oauth:client:list` | è·å–å®¢æˆ·ç«¯åˆ—è¡¨ |
| POST | `/api/oauth/clients` | `oauth:client:create` | åˆ›å»ºå®¢æˆ·ç«¯ |
| PUT | `/api/oauth/clients/:id` | `oauth:client:edit` | æ›´æ–°å®¢æˆ·ç«¯ |
| DELETE | `/api/oauth/clients/:id` | `oauth:client:delete` | åˆ é™¤å®¢æˆ·ç«¯ |
| POST | `/api/oauth/clients/:id/reset-secret` | `oauth:client:resetSecret` | é‡ç½®å®¢æˆ·ç«¯å¯†é’¥ |

#### æƒé™ç»„ç®¡ç†

| æ–¹æ³• | è·¯å¾„ | æƒé™ | è¯´æ˜ |
|------|------|------|------|
| GET | `/api/oauth/permission-groups` | `oauth:group:list` | è·å–æƒé™ç»„åˆ—è¡¨ |
| POST | `/api/oauth/permission-groups` | `oauth:group:create` | åˆ›å»ºæƒé™ç»„ |
| PUT | `/api/oauth/permission-groups/:id` | `oauth:group:edit` | æ›´æ–°æƒé™ç»„ |
| DELETE | `/api/oauth/permission-groups/:id` | `oauth:group:delete` | åˆ é™¤æƒé™ç»„ |

#### é¢„å®šä¹‰æƒé™ç»„

| ID | group_key | group_name | description |
|----|-----------|------------|-------------|
| 1 | user_read | ç”¨æˆ·åªè¯» | åªè¯»è®¿é—®ç”¨æˆ·ä¿¡æ¯ |
| 2 | user_full | ç”¨æˆ·ç®¡ç† | å®Œæ•´çš„ç”¨æˆ·ç®¡ç†æƒé™ |
| 3 | role_read | è§’è‰²åªè¯» | åªè¯»è®¿é—®è§’è‰²ä¿¡æ¯ |
| 4 | role_full | è§’è‰²ç®¡ç† | å®Œæ•´çš„è§’è‰²ç®¡ç†æƒé™ |
| 5 | r2_read | R2åªè¯» | åªè¯»è®¿é—®R2æ–‡ä»¶ |
| 6 | r2_full | R2ç®¡ç† | å®Œæ•´çš„R2ç®¡ç†æƒé™ |
| 7 | kv_full | KVç®¡ç† | å®Œæ•´çš„KVå­˜å‚¨æƒé™ |
| 8 | admin_all | å…¨éƒ¨æƒé™ | æ‰€æœ‰ç³»ç»Ÿæƒé™ |

---

## é™„å½•

### ç›¸å…³æ–‡æ¡£

- [éƒ¨ç½²æŒ‡å—](./deploy-guide.md) - Cloudflare Workers éƒ¨ç½²é…ç½®
- [ç®€åŒ–éƒ¨ç½²æŒ‡å—](./deploy-guide-simple.md) - Git Integration éƒ¨ç½²æ–¹å¼
- [éƒ¨ç½²æ–¹å¼å¯¹æ¯”](./deploy-comparison.md) - éƒ¨ç½²æ–¹æ¡ˆé€‰æ‹©æŒ‡å—

### å¿«æ·å‘½ä»¤å‚è€ƒ

```bash
# å¼€å‘
npm run dev              # å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨
npm run wrangler         # å¯åŠ¨åç«¯å¼€å‘æœåŠ¡å™¨
npm run sync             # åŒæ­¥è¿œç¨‹æ•°æ®

# åŒæ­¥
npm run kv:export        # å¯¼å‡º KV åˆ°è¿œç¨‹
npm run d1:export        # å¯¼å‡º D1 åˆ°è¿œç¨‹
npm run schema:remote-to-schema  # è¿œç¨‹ â†’ schema-data.json

# éƒ¨ç½²
npm run build            # æ„å»ºé¡¹ç›®
npm run deploy           # éƒ¨ç½²åˆ° Workers
npm run check            # å®Œæ•´æ£€æŸ¥
```

**æœ€åæ›´æ–°**ï¼š2026-01-20
