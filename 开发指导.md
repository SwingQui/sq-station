
# 开发指导

## API Token 配置

项目已支持通过 `.dev.vars` 文件配置 Cloudflare API Token，无需手动登录即可执行远程命令。

### 配置方式

1. 复制示例文件：
```bash
cp .dev.vars.example .dev.vars
```

2. 编辑 `.dev.vars` 文件，将 Token 替换为你的实际值：
```bash
CLOUDFLARE_API_TOKEN=你的token
```

**注意**：`.dev.vars` 文件已添加到 `.gitignore`，不会提交到 Git。

### 获取 API Token

1. 访问 https://dash.cloudflare.com/profile/api-tokens
2. 创建 Token，需要以下权限：
   - **Account** → **D1** → **Edit**
   - **Account** → **Workers Scripts** → **Edit**
   - **Account** → **Cloudflare R2** → **Edit**（如需使用 R2）

### 使用方式

配置 Token 后，以下命令会自动使用项目中的 Token：
```bash
npm run d1:migrate     # 同步 schema 到远程 D1
npm run d1:query      # 查询远程 D1
npm run deploy        # 部署到 Workers
```

## 项目说明

本项目是基于 Cloudflare Workers 的全栈应用，使用以下技术：
- **后端**: Hono + Cloudflare Workers
- **前端**: React + TypeScript + Vite
- **数据库**: D1 (SQLite)
- **KV存储**: Cloudflare Workers KV
- **对象存储**: Cloudflare R2

### worker-configuration.d.ts 说明

`worker-configuration.d.ts` 是由 Wrangler 自动生成的 TypeScript 类型定义文件。

**作用：**
- 为 `wrangler.json` 中配置的所有绑定（KV、D1、R2）提供 TypeScript 类型定义
- 在代码中获得完整的类型提示和 IntelliSense 支持
- 避免拼写错误和类型不匹配的问题

**何时重新生成：**
- 修改 `wrangler.json` 后（添加/删除绑定、环境变量等）
- 运行命令：`npx wrangler types`

**生成的类型示例：**
```typescript
interface Env {
  KV_BINDING: KVNamespace;
  R2_BINDING: R2Bucket;
  DB: D1Database;
  JWT_SECRET: string;
  JWT_EXPIRES_IN: string;
}
```

## 命令

### 开发服务
```bash
# 双服务器开发模式（推荐：支持前端热更新）
npm run sync        # 同步远程数据 (KV + D1) 到本地
npm run dev         # 前端开发服务器 (Vite，端口 5173，支持热更新)
npm run wrangler    # 后端开发服务器 (Wrangler，端口 8787)

# 单服务器开发模式
npm run dev:auto    # 自动同步数据 + 启动 Wrangler (端口 8787，无热更新)
npm run dev:remote  # 直连远程数据开发

# 构建/部署
npm run build        # TypeScript 编译 + Vite 打包
npm run deploy       # 部署到 Cloudflare Workers
npm run check        # 完整检查 (TS + 打包 + 部署预演)
npm run preview      # 构建并预览
npm run lint         # ESLint 代码检查
npm run cf-typegen   # 生成 Cloudflare 类型定义
```

### KV 存储
```bash
npm run kv:import    # 从远程 KV 导入到本地
npm run kv:export    # 从本地导出到远程 KV (自动备份，存放在 .wrangler/kv-backup/)
```

### D1 数据库 (权限系统)

**⚠️ 重要：首次使用前必须执行表结构迁移（只需一次）**
```bash
npm run d1:migrate       # 远程初始化 (执行 schema.sql)
npm run d1:migrate:local # 本地初始化 (执行 schema.sql)
```

**数据同步命令:**
```bash
# 数据同步 (带自动备份，备份存放在 .wrangler/d1-backup/)
npm run d1:export      # 本地 -> 远程 (导出前自动备份)
npm run d1:import      # 远程 -> 本地

# 仅备份
npm run d1:backup:remote  # 备份远程数据到 .wrangler/d1-backup/
npm run d1:backup:local   # 备份本地数据到 .wrangler/d1-backup/

# 查询
npm run d1:query "SELECT * FROM sys_user"      # 查询远程 D1
npm run d1:query:local "SELECT * FROM sys_user" # 查询本地 D1
```

**备份目录:** `.wrangler/d1-backup/` (与 KV 备份位置一致)

## KV 接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/kv` | 列出所有 key |
| GET | `/api/kv/:key` | 获取单个值 |
| PUT | `/api/kv/:key` | 设置值 (body: `{"value":"xxx"}`) |
| DELETE | `/api/kv/:key` | 删除值 |
| POST | `/api/kv/sync` | 同步所有远程数据 |

## R2 接口 (对象存储)

### 文件管理
| 方法 | 路径 | 权限 | 说明 |
|------|------|------|------|
| GET | `/api/r2` | `r2:file:list` | 列出所有对象 (支持 limit、cursor、prefix 查询参数) |
| GET | `/api/r2/:key` | `r2:file:view` | 获取对象 (返回元数据或文件内容，根据 Accept 头；下载文件需额外 `r2:file:download` 权限) |
| GET | `/api/r2/:key/metadata` | `r2:file:view` | 获取对象元数据 |
| PUT | `/api/r2/:key` | `r2:file:upload` | 上传对象 (支持 JSON 文本或 multipart/form-data 文件) |
| DELETE | `/api/r2/:key` | `r2:file:delete` | 删除单个对象 |
| POST | `/api/r2/delete` | `r2:file:delete` | 批量删除 (body: `{"keys":["key1","key2"]}`) |

### 文件夹管理
| 方法 | 路径 | 权限 | 说明 |
|------|------|------|------|
| GET | `/api/r2/folders` | `r2:folder:list` | 获取文件夹列表 (支持 prefix 查询参数) |
| PUT | `/api/r2/folder/:path` | `r2:folder:create` | 创建文件夹 (递归创建，如 `folder1/subfolder`) |
| DELETE | `/api/r2/folder/:path` | `r2:folder:delete` | 删除文件夹 (递归删除所有内容) |

### R2 上传示例

**上传文本/JSON：**
```bash
curl -X PUT http://localhost:8787/api/r2/test.txt \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"value":"Hello World","httpMetadata":{"contentType":"text/plain"}}'
```

**上传文件：**
```bash
curl -X PUT http://localhost:8787/api/r2/images/photo.jpg \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@/path/to/photo.jpg"
```

**上传到指定文件夹：**
```bash
# 上传到 folder1 目录
curl -X PUT http://localhost:8787/api/r2/folder1/photo.jpg \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@/path/to/photo.jpg"

# 上传到深层目录 folder1/subfolder
curl -X PUT http://localhost:8787/api/r2/folder1/subfolder/doc.pdf \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@/path/to/doc.pdf"
```

### R2 文件夹操作示例

**创建文件夹：**
```bash
# 创建单层文件夹
curl -X PUT http://localhost:8787/api/r2/folder/myfolder \
  -H "Authorization: Bearer YOUR_TOKEN"

# 创建多层文件夹
curl -X PUT http://localhost:8787/api/r2/folder/folder1/subfolder \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**获取文件夹列表：**
```bash
# 获取根目录下的文件夹
curl http://localhost:8787/api/r2/folders \
  -H "Authorization: Bearer YOUR_TOKEN"

# 获取指定路径下的文件夹
curl http://localhost:8787/api/r2/folders?prefix=folder1/ \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**删除文件夹（递归删除所有内容）：**
```bash
curl -X DELETE http://localhost:8787/api/r2/folder/myfolder \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### R2 下载示例

**下载文件：**
```bash
# 直接下载（返回文件内容）
curl http://localhost:8787/api/r2/test.txt \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -o downloaded.txt

# 获取元数据（返回 JSON）
curl http://localhost:8787/api/r2/test.txt/metadata \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## D1 接口 (权限系统)

### R2 权限说明

R2 接口需要相应权限才能访问，权限格式为 `r2:类型:操作`：

| 权限标识 | 说明 |
|---------|------|
| `r2:file:list` | 查看文件列表 |
| `r2:file:upload` | 上传文件 |
| `r2:file:download` | 下载文件 |
| `r2:file:delete` | 删除文件 |
| `r2:file:view` | 查看文件详情 |
| `r2:folder:list` | 查看文件夹列表 |
| `r2:folder:create` | 创建文件夹 |
| `r2:folder:delete` | 删除文件夹 |

**注意**：下载文件需要同时拥有 `r2:file:view` 和 `r2:file:download` 权限。

### 用户管理
| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/users` | 获取用户列表 |
| GET | `/api/users/:id` | 获取单个用户 |
| POST | `/api/users` | 创建用户 |
| PUT | `/api/users/:id` | 更新用户 |
| DELETE | `/api/users/:id` | 删除用户 |
| GET | `/api/users/:id/roles` | 获取用户角色 |
| PUT | `/api/users/:id/roles` | 分配角色 |

### 角色管理
| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/roles` | 获取角色列表 |
| GET | `/api/roles/:id` | 获取单个角色 |
| POST | `/api/roles` | 创建角色 |
| PUT | `/api/roles/:id` | 更新角色 |
| DELETE | `/api/roles/:id` | 删除角色 |
| GET | `/api/roles/:id/menus` | 获取角色菜单 |
| PUT | `/api/roles/:id/menus` | 分配菜单 |

### 菜单管理
| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/menus` | 获取菜单树 |
| GET | `/api/menus/:id` | 获取单个菜单 |
| POST | `/api/menus` | 创建菜单 |
| PUT | `/api/menus/:id` | 更新菜单 |
| DELETE | `/api/menus/:id` | 删除菜单 |

### 权限验证
| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/user/:id/menus` | 获取用户可访问菜单 |
| GET | `/api/user/:id/permissions` | 获取用户权限列表 |

### SQL 执行工具
| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/sql/query` | 执行 SQL 语句 (支持 SELECT / INSERT / UPDATE / DELETE / CREATE / DROP 等) |

## 前端页面

| 路径 | 页面 | 说明 |
|------|------|------|
| `/` | Home | 前台首页 |
| `/dashboard/home` | Home | 仪表盘首页 |
| `/dashboard/system/user` | UserManage | 用户管理 |
| `/dashboard/system/role` | RoleManage | 角色管理 |
| `/dashboard/system/menu` | MenuManage | 菜单管理 |
| `/dashboard/system/organization` | OrganizationManage | 组织管理 |
| `/dashboard/system/kv` | KVManage | KV 管理 |
| `/dashboard/system/r2` | R2Manage | R2 对象存储管理 |
| `/dashboard/system/oauth` | OAuthClientManage | OAuth 客户端管理 |
| `/dashboard/system/oauth-groups` | OAuthPermissionGroupManage | 权限组管理 |
| `/dashboard/system/sql` | SQLSearch | SQL 执行工具 |

## 使用示例

### KV 示例
```bash
# 列出所有 keys
curl http://localhost:8787/api/kv

# 获取值
curl http://localhost:8787/api/kv/mykey

# 设置值
curl -X PUT http://localhost:8787/api/kv/mykey -H "Content-Type: application/json" -d "{\"value\":\"hello\"}"

# 删除值
curl -X DELETE http://localhost:8787/api/kv/mykey
```

### D1 示例
```bash
# 获取用户列表
curl http://localhost:8787/api/users

# 创建用户
curl -X POST http://localhost:8787/api/users -H "Content-Type: application/json" -d "{\"username\":\"test\",\"password\":\"123456\",\"nickname\":\"测试用户\"}"

# 获取用户菜单权限
curl http://localhost:8787/api/user/1/menus
```

### R2 示例
```bash
# 列出所有对象
curl http://localhost:8787/api/r2

# 上传文本
curl -X PUT http://localhost:8787/api/r2/hello.txt \
  -H "Content-Type: application/json" \
  -d '{"value":"Hello R2!"}'

# 上传文件
curl -X PUT http://localhost:8787/api/r2/photo.jpg \
  -F "file=@/path/to/photo.jpg"

# 下载文件
curl http://localhost:8787/api/r2/hello.txt -o hello.txt

# 获取对象元数据
curl http://localhost:8787/api/r2/hello.txt/metadata

# 删除对象
curl -X DELETE http://localhost:8787/api/r2/hello.txt

# 批量删除
curl -X POST http://localhost:8787/api/r2/delete \
  -H "Content-Type: application/json" \
  -d '{"keys":["file1.txt","file2.jpg"]}'
```

### SQL 执行工具示例
```bash
# 执行查询
curl -X POST http://localhost:8787/api/sql/query -H "Content-Type: application/json" -d "{\"sql\":\"SELECT * FROM sys_user\"}"

# 执行插入
curl -X POST http://localhost:8787/api/sql/query -H "Content-Type: application/json" -d "{\"sql\":\"INSERT INTO sys_user (username, password, nickname) VALUES ('test', '123456', '测试')\"}"

# 执行更新
curl -X POST http://localhost:8787/api/sql/query -H "Content-Type: application/json" -d "{\"sql\":\"UPDATE sys_user SET nickname = '新昵称' WHERE username = 'test\"}"
```

**Web 界面:** 访问 `/system/sql` 使用可视化 SQL 执行工具
**Web 界面:** 访问 `/system/r2` 使用 R2 对象存储管理工具

## 接口缓存

项目实现了 GET 请求的接口缓存功能，可以有效减少数据库查询，提高响应速度。

### 缓存配置

缓存配置位于 `src/worker/config/app.config.ts`：

```typescript
cache: {
    enabled: true,           // 是否启用缓存
    defaultTTL: 2000,       // 默认缓存时间（毫秒）
    excludeRoutes: [         // 排除的路由（支持通配符）
        "/api/r2/*",         // 排除所有 R2 接口
        "/api/kv/*",         // 排除所有 KV 接口
    ],
}
```

### 缓存工作原理

1. **首次请求**：执行正常逻辑，返回数据并缓存
2. **缓存命中**：2秒内（默认）相同参数的请求直接返回缓存数据
3. **缓存过期**：超过 TTL 时间后，缓存自动失效，下次请求重新获取数据

### 缓存日志

开发环境会输出缓存日志，便于调试：

```
[缓存] 未命中: /api/users
[缓存] 已设置: /api/users (TTL: 2000ms)
[缓存] 命中: /api/users (剩余 1850ms)
[缓存] 已过期删除: /api/users
```

### 缓存管理接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/cache/stats` | 查看缓存统计信息 |
| GET | `/api/cache/test` | 测试缓存是否生效 |
| POST | `/api/cache/clear` | 清除所有缓存 |

### 缓存测试

**验证缓存是否生效：**
```bash
# 第一次请求，会返回真实数据
curl http://localhost:8787/api/cache/test

# 2秒内再次请求，会返回相同的时间戳（来自缓存）
curl http://localhost:8787/api/cache/test

# 等待2秒后请求，会返回新的时间戳（缓存已过期）
curl http://localhost:8787/api/cache/test
```

### 缓存键生成

缓存键基于 `路径 + 查询参数` 生成，查询参数按字母顺序排列：

```
# 以下请求会生成相同的缓存键
/api/users?status=1&page=1
/api/users?page=1&status=1
```

## OAuth 2.0 单点登录

项目实现了 OAuth 2.0 Client Credentials 授权流程，允许外部系统通过获取 Access Token 来访问受保护的 API 资源。

**核心设计**：OAuth 客户端通过绑定**权限组**来获得访问权限，权限完全由权限组决定，支持动态管理。

### OAuth 2.0 流程图

```
外部系统                          本项目
    |                               |
    |  1. POST /oauth/token         |
    |     grant_type=client_credentials  |
    |     client_id=xxx             |
    |     client_secret=xxx         |
    |------------------------------->|
    |                               |
    |                               | 2. 验证客户端凭据
    |                               | 3. 获取绑定的权限组
    |                               | 4. 生成 Access Token (JWT)
    |                               |
    |  5. access_token, expires_in  |
    |<-------------------------------|
    |                               |
    |  6. GET /api/users            |
    |     Authorization: Bearer xxx  |
    |------------------------------->|
    |                               |
    |                               | 7. 验证 Token
    |                               | 8. 检查权限组权限
    |                               |
    |  9. 用户数据                   |
    |<-------------------------------|
```

### 获取 Access Token

**请求端点：** `POST /oauth/token`

**请求体：**
```json
{
  "grant_type": "client_credentials",
  "client_id": "client_xxxxxxxxxxxxxxxxxxxxxxx",
  "client_secret": "cs_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
}
```

**响应：**
```json
{
  "code": 200,
  "data": {
    "access_token": "eyJhbGc...",
    "token_type": "Bearer",
    "expires_in": 3600
  }
}
```

**注意**：Token 的权限由客户端绑定的权限组决定，无需在请求中指定 scope。

### 使用 Token 访问 API

获取 Token 后，在请求头中携带 `Authorization: Bearer {token}` 即可访问受保护的 API：

```bash
curl -X GET https://your-project.com/api/users \
  -H "Authorization: Bearer eyJhbGc..."
```

### 权限组管理

OAuth 客户端通过绑定权限组来获得访问权限。权限组是预定义的权限模板，修改权限组后，所有绑定客户端的权限会自动更新。

#### 预定义权限组

| ID | group_key | group_name | description |
|----|-----------|------------|-------------|
| 1 | user_read | 用户只读 | 只读访问用户信息 |
| 2 | user_full | 用户管理 | 完整的用户管理权限 |
| 3 | role_read | 角色只读 | 只读访问角色信息 |
| 4 | role_full | 角色管理 | 完整的角色管理权限 |
| 5 | r2_read | R2只读 | 只读访问R2文件 |
| 6 | r2_full | R2管理 | 完整的R2管理权限 |
| 7 | kv_full | KV管理 | 完整的KV存储权限 |
| 8 | admin_all | 全部权限 | 所有系统权限 |

#### 权限组管理接口

| 方法 | 路径 | 权限 | 说明 |
|------|------|------|------|
| GET | `/api/oauth/permission-groups` | `oauth:group:list` | 获取权限组列表 |
| POST | `/api/oauth/permission-groups` | `oauth:group:create` | 创建权限组 |
| PUT | `/api/oauth/permission-groups/:id` | `oauth:group:edit` | 更新权限组 |
| DELETE | `/api/oauth/permission-groups/:id` | `oauth:group:delete` | 删除权限组 |

**Web 界面:** 访问 `/system/oauth-groups` 使用权限组管理工具

### OAuth 客户端管理

OAuth 客户端需要在系统中预先创建，获得 `client_id` 和 `client_secret`，并绑定权限组。

#### 客户端管理接口

| 方法 | 路径 | 权限 | 说明 |
|------|------|------|------|
| GET | `/api/oauth/clients` | `oauth:client:list` | 获取客户端列表 |
| POST | `/api/oauth/clients` | `oauth:client:create` | 创建客户端 |
| PUT | `/api/oauth/clients/:id` | `oauth:client:edit` | 更新客户端 |
| DELETE | `/api/oauth/clients/:id` | `oauth:client:delete` | 删除客户端 |
| POST | `/api/oauth/clients/:id/reset-secret` | `oauth:client:resetSecret` | 重置客户端密钥 |

#### 创建客户端示例

**请求：**
```bash
curl -X POST http://localhost:8787/api/oauth/clients \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "client_name": "外部系统集成",
    "description": "用于外部系统访问用户列表接口",
    "permission_group_ids": [1, 3],
    "expires_in": 7200
  }'
```

**参数说明：**
- `permission_group_ids`: 权限组ID数组（必填），客户端权限 = 所有绑定权限组的权限并集
- `expires_in`: Token 有效期（秒），默认 3600

**响应（仅此一次返回明文密钥）：**
```json
{
  "code": 200,
  "data": {
    "id": 1,
    "client_id": "client_xxx",
    "client_secret": "cs_xxx",
    "client_name": "外部系统集成",
    "description": "用于外部系统访问用户列表接口",
    "permission_group_ids": "[1,3]",
    "expires_in": 7200,
    "status": 1
  },
  "message": "客户端创建成功"
}
```

#### 权限组组合示例

一个客户端可以绑定多个权限组，权限会自动合并：

```json
{
  "client_name": "综合管理系统",
  "permission_group_ids": [1, 5, 7]
}
```

**权限合并结果：**
- `user_read` (用户只读) + `r2_read` (R2只读) + `kv_full` (KV管理)
- 客户端最终获得：用户列表查看、R2文件查看、KV完整管理权限

### Token 权限验证

当使用 OAuth Token 访问 API 时，系统会自动验证：

1. **Token 有效性**：Token 是否由系统签发且未过期
2. **权限组权限**：客户端绑定权限组的权限是否包含当前 API 所需权限

例如访问 `/api/users` 需要权限 `system:user:list`：
- ✅ 如果客户端绑定的权限组包含 `system:user:list`，则允许访问
- ❌ 如果客户端绑定的权限组不包含该权限，则返回 403 无权限

### 动态权限更新

权限组的优势在于**动态更新**：

1. **修改权限组**：在权限组管理页面修改权限组的权限列表
2. **自动生效**：所有绑定该权限组的客户端，下次获取 Token 时会自动使用新权限
3. **无需修改客户端**：不需要逐个修改每个 OAuth 客户端

**示例场景：**
```
1. 创建权限组 "新功能访问"，权限为 ["new:feature:view"]
2. 将权限组绑定到 10 个 OAuth 客户端
3. 新功能上线后，只需要修改权限组，添加 ["new:feature:edit"]
4. 所有 10 个客户端自动获得编辑权限，无需逐个修改
```

### OAuth 完整使用示例

#### 1. 创建权限组（可选）

如果预定义权限组不满足需求，可以先创建自定义权限组：

```bash
curl -X POST http://localhost:8787/api/oauth/permission-groups \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "group_key": "custom_read",
    "group_name": "自定义只读",
    "description": "自定义只读权限",
    "permissions": ["system:user:list", "system:role:list"],
    "sort_order": 10
  }'
```

#### 2. 创建客户端

```bash
curl -X POST http://localhost:8787/api/oauth/clients \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "client_name": "测试外部系统",
    "description": "用于测试 OAuth 集成",
    "permission_group_ids": [1, 5],
    "expires_in": 3600
  }'
```

保存返回的 `client_id` 和 `client_secret`。

#### 3. 获取 Access Token

```bash
curl -X POST http://localhost:8787/oauth/token \
  -H "Content-Type: application/json" \
  -d '{
    "grant_type": "client_credentials",
    "client_id": "client_xxx",
    "client_secret": "cs_xxx"
  }'
```

保存返回的 `access_token`。

#### 4. 使用 Token 访问 API

```bash
curl -X GET http://localhost:8787/api/users \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

#### 5. 修改权限组（动态更新）

```bash
# 更新权限组，添加新权限
curl -X PUT http://localhost:8787/api/oauth/permission-groups/1 \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "permissions": ["system:user:list", "system:user:add", "system:user:edit"]
  }'

# 下次客户端获取 Token 时，会自动获得新添加的权限
```

### 错误处理

| 错误码 | 说明 |
|--------|------|
| 400 | `grant_type` 不支持或缺少必需参数 |
| 401 | 客户端凭据无效、客户端被禁用、未绑定权限组 |
| 403 | 权限组不包含所需权限 |

### 安全建议

1. **妥善保管 `client_secret`**：仅在创建/重置时显示，请妥善保存
2. **最小权限原则**：权限组只授予实际需要的权限
3. **定期轮换密钥**：发现密钥泄露时，使用重置接口更换
4. **设置合理的过期时间**：根据使用场景设置 Token 有效期
5. **监控客户端使用**：定期检查客户端的访问日志
6. **权限组命名规范**：使用清晰的命名，如 `xxx_read`、`xxx_full`

### OAuth 权限说明

#### 客户端管理权限

| 权限标识 | 说明 |
|---------|------|
| `oauth:client:list` | 查看客户端列表 |
| `oauth:client:create` | 创建新客户端 |
| `oauth:client:edit` | 编辑客户端信息 |
| `oauth:client:delete` | 删除客户端 |
| `oauth:client:resetSecret` | 重置客户端密钥 |

#### 权限组管理权限

| 权限标识 | 说明 |
|---------|------|
| `oauth:group:list` | 查看权限组列表 |
| `oauth:group:create` | 创建权限组 |
| `oauth:group:edit` | 编辑权限组 |
| `oauth:group:delete` | 删除权限组 |

**Web 界面:**
- 访问 `/dashboard/system/oauth` 使用 OAuth 客户端管理工具
- 访问 `/dashboard/system/oauth-groups` 使用权限组管理工具

### Token 有效期 vs OAuth 客户端

理解 **Token 有效期** 和 **OAuth 客户端** 的区别非常重要：

#### Token 有效期 (`expires_in`)

Token 有效期是指 **access_token** 的有效期，不是 OAuth 客户端的有效期。

```
┌─────────────────────────────────────────────────────────────┐
│  OAuth 客户端 (持久化存在于数据库)                            │
│  client_id: "test-client"                                    │
│  client_secret: "xxx..."                                     │
│  绑定权限组: [1, 5] (user_read + r2_read)                    │
│  ↓ 可以无限次调用                                             │
├─────────────────────────────────────────────────────────────┤
│  每次调用 /oauth/token 获得一个 access_token (临时)          │
│  token 有效期: 3600秒 (1小时)                                │
│  token 权限 = 权限组权限并集                                   │
│  ↓                                                           │
│  过期后重新调用获取新 token                                   │
└─────────────────────────────────────────────────────────────┘
```

#### OAuth 客户端

- **持久化存储**：创建后一直存在于数据库中，除非手动删除
- **可重复使用**：无限次调用 `/oauth/token` 接口获取 token
- **权限由权限组决定**：修改权限组后，新获取的 token 会自动使用最新权限

#### 完整使用流程

```bash
# 1. 第一次获取 token
curl -X POST http://localhost:8787/oauth/token \
  -H "Content-Type: application/json" \
  -d '{
    "grant_type": "client_credentials",
    "client_id": "client_xxx",
    "client_secret": "cs_xxx"
  }'

# 返回: { "access_token": "eyJ...", "expires_in": 3600, "token_type": "Bearer" }

# 2. 使用 token 调用 API (1小时内有效)
curl http://localhost:8787/api/users \
  -H "Authorization: Bearer eyJ..."

# 3. Token 过期后，重新获取 (同样的 client_id 和 client_secret)
curl -X POST http://localhost:8787/oauth/token \
  -H "Content-Type: application/json" \
  -d '{
    "grant_type": "client_credentials",
    "client_id": "client_xxx",
    "client_secret": "cs_xxx"
  }'

# 又得到一个新的 token，再使用1小时
```

#### 对比总结

| 项目 | 性质 | 有效期 | 说明 |
|------|------|--------|------|
| **OAuth 客户端** (client_id + secret) | 永久 | 一直存在，除非手动删除 | 用于获取 access_token 的凭据 |
| **权限组** | 永久 | 一直存在，除非手动删除 | 决定客户端的访问权限 |
| **access_token** | 临时 | `expires_in` 指定的时间（如1小时） | 用于访问 API 的临时凭据 |

**总结**：OAuth 客户端会一直存在，每次需要时调用 `/oauth/token` 接口获取新的 token 即可。修改权限组后，新获取的 token 会自动更新权限。

