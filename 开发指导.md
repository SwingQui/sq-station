
# 开发指导

## API Token 配置

项目已支持通过 `.dev.vars` 文件配置 Cloudflare API Token，无需手动登录即可执行远程命令。

### 配置方式

1. 复制示例文件：
```bash
cp .dev.vars.example .dev.vars
```

2. 编辑 `.dev.vars` 文件，将 Token 替换为你的实际值：
```bash
CLOUDFLARE_API_TOKEN=你的token
```

**注意**：`.dev.vars` 文件已添加到 `.gitignore`，不会提交到 Git。

### 获取 API Token

1. 访问 https://dash.cloudflare.com/profile/api-tokens
2. 创建 Token，需要以下权限：
   - **Account** → **D1** → **Edit**
   - **Account** → **Workers Scripts** → **Edit**
   - **Account** → **Cloudflare R2** → **Edit**（如需使用 R2）

### 使用方式

配置 Token 后，以下命令会自动使用项目中的 Token：
```bash
npm run d1:migrate     # 同步 schema 到远程 D1
npm run d1:query      # 查询远程 D1
npm run deploy        # 部署到 Workers
```

## 项目说明

本项目是基于 Cloudflare Workers 的全栈应用，使用以下技术：
- **后端**: Hono + Cloudflare Workers
- **前端**: React + TypeScript + Vite
- **数据库**: D1 (SQLite)
- **KV存储**: Cloudflare Workers KV
- **对象存储**: Cloudflare R2

### worker-configuration.d.ts 说明

`worker-configuration.d.ts` 是由 Wrangler 自动生成的 TypeScript 类型定义文件。

**作用：**
- 为 `wrangler.json` 中配置的所有绑定（KV、D1、R2）提供 TypeScript 类型定义
- 在代码中获得完整的类型提示和 IntelliSense 支持
- 避免拼写错误和类型不匹配的问题

**何时重新生成：**
- 修改 `wrangler.json` 后（添加/删除绑定、环境变量等）
- 运行命令：`npx wrangler types`

**生成的类型示例：**
```typescript
interface Env {
  KV_BINDING: KVNamespace;
  R2_BINDING: R2Bucket;
  DB: D1Database;
  JWT_SECRET: string;
  JWT_EXPIRES_IN: string;
}
```

## 命令

### 开发服务
```bash
# 双服务器开发模式（推荐：支持前端热更新）
npm run sync        # 同步远程数据 (KV + D1) 到本地
npm run dev         # 前端开发服务器 (Vite，端口 5173，支持热更新)
npm run wrangler    # 后端开发服务器 (Wrangler，端口 8787)

# 单服务器开发模式
npm run dev:auto    # 自动同步数据 + 启动 Wrangler (端口 8787，无热更新)
npm run dev:remote  # 直连远程数据开发

# 构建/部署
npm run build        # TypeScript 编译 + Vite 打包
npm run deploy       # 部署到 Cloudflare Workers
npm run check        # 完整检查 (TS + 打包 + 部署预演)
npm run preview      # 构建并预览
npm run lint         # ESLint 代码检查
npm run cf-typegen   # 生成 Cloudflare 类型定义
```

### KV 存储
```bash
npm run kv:import    # 从远程 KV 导入到本地
npm run kv:export    # 从本地导出到远程 KV (自动备份，存放在 .wrangler/kv-backup/)
```

### D1 数据库 (权限系统)

**⚠️ 重要：首次使用前必须执行表结构迁移（只需一次）**
```bash
npm run d1:migrate       # 远程初始化 (执行 schema.sql)
npm run d1:migrate:local # 本地初始化 (执行 schema.sql)
```

**数据同步命令:**
```bash
# 数据同步 (带自动备份，备份存放在 .wrangler/d1-backup/)
npm run d1:export      # 本地 -> 远程 (导出前自动备份)
npm run d1:import      # 远程 -> 本地

# 仅备份
npm run d1:backup:remote  # 备份远程数据到 .wrangler/d1-backup/
npm run d1:backup:local   # 备份本地数据到 .wrangler/d1-backup/

# 查询
npm run d1:query "SELECT * FROM sys_user"      # 查询远程 D1
npm run d1:query:local "SELECT * FROM sys_user" # 查询本地 D1
```

**备份目录:** `.wrangler/d1-backup/` (与 KV 备份位置一致)

## KV 接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/kv` | 列出所有 key |
| GET | `/api/kv/:key` | 获取单个值 |
| PUT | `/api/kv/:key` | 设置值 (body: `{"value":"xxx"}`) |
| DELETE | `/api/kv/:key` | 删除值 |
| POST | `/api/kv/sync` | 同步所有远程数据 |

## R2 接口 (对象存储)

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/r2` | 列出所有对象 (支持 limit、cursor、prefix 查询参数) |
| GET | `/api/r2/:key` | 获取对象 (返回元数据或文件内容，根据 Accept 头) |
| GET | `/api/r2/:key/metadata` | 获取对象元数据 |
| PUT | `/api/r2/:key` | 上传对象 (支持 JSON 文本或 multipart/form-data 文件) |
| DELETE | `/api/r2/:key` | 删除单个对象 |
| POST | `/api/r2/delete` | 批量删除 (body: `{"keys":["key1","key2"]}`) |

### R2 上传示例

**上传文本/JSON：**
```bash
curl -X PUT http://localhost:8787/api/r2/test.txt \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"value":"Hello World","httpMetadata":{"contentType":"text/plain"}}'
```

**上传文件：**
```bash
curl -X PUT http://localhost:8787/api/r2/images/photo.jpg \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@/path/to/photo.jpg"
```

### R2 下载示例

**下载文件：**
```bash
# 直接下载（返回文件内容）
curl http://localhost:8787/api/r2/test.txt \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -o downloaded.txt

# 获取元数据（返回 JSON）
curl http://localhost:8787/api/r2/test.txt/metadata \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## D1 接口 (权限系统)

### 用户管理
| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/users` | 获取用户列表 |
| GET | `/api/users/:id` | 获取单个用户 |
| POST | `/api/users` | 创建用户 |
| PUT | `/api/users/:id` | 更新用户 |
| DELETE | `/api/users/:id` | 删除用户 |
| GET | `/api/users/:id/roles` | 获取用户角色 |
| PUT | `/api/users/:id/roles` | 分配角色 |

### 角色管理
| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/roles` | 获取角色列表 |
| GET | `/api/roles/:id` | 获取单个角色 |
| POST | `/api/roles` | 创建角色 |
| PUT | `/api/roles/:id` | 更新角色 |
| DELETE | `/api/roles/:id` | 删除角色 |
| GET | `/api/roles/:id/menus` | 获取角色菜单 |
| PUT | `/api/roles/:id/menus` | 分配菜单 |

### 菜单管理
| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/menus` | 获取菜单树 |
| GET | `/api/menus/:id` | 获取单个菜单 |
| POST | `/api/menus` | 创建菜单 |
| PUT | `/api/menus/:id` | 更新菜单 |
| DELETE | `/api/menus/:id` | 删除菜单 |

### 权限验证
| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/user/:id/menus` | 获取用户可访问菜单 |
| GET | `/api/user/:id/permissions` | 获取用户权限列表 |

### SQL 执行工具
| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/sql/query` | 执行 SQL 语句 (支持 SELECT / INSERT / UPDATE / DELETE / CREATE / DROP 等) |

## 前端页面

| 路径 | 页面 | 说明 |
|------|------|------|
| `/` | Home | 前台首页 |
| `/page1` | Page1 | 前台页面1 |
| `/page2` | Page2 | 前台页面2 |
| `/system` | Menu | 后台首页 |
| `/system/page1` | MenuPage1 | 后台页面1 |
| `/system/page2` | MenuPage2 | 后台页面2 |
| `/system/user` | UserManage | 用户管理 |
| `/system/role` | RoleManage | 角色管理 |
| `/system/menu` | MenuManage | 菜单管理 |
| `/system/organization` | OrganizationManage | 组织管理 |
| `/system/kv` | TestKV | KV 管理 |
| `/system/r2` | TestR2 | R2 对象存储管理 |
| `/system/sql` | SQLSearch | SQL 执行工具 |

## 使用示例

### KV 示例
```bash
# 列出所有 keys
curl http://localhost:8787/api/kv

# 获取值
curl http://localhost:8787/api/kv/mykey

# 设置值
curl -X PUT http://localhost:8787/api/kv/mykey -H "Content-Type: application/json" -d "{\"value\":\"hello\"}"

# 删除值
curl -X DELETE http://localhost:8787/api/kv/mykey
```

### D1 示例
```bash
# 获取用户列表
curl http://localhost:8787/api/users

# 创建用户
curl -X POST http://localhost:8787/api/users -H "Content-Type: application/json" -d "{\"username\":\"test\",\"password\":\"123456\",\"nickname\":\"测试用户\"}"

# 获取用户菜单权限
curl http://localhost:8787/api/user/1/menus
```

### R2 示例
```bash
# 列出所有对象
curl http://localhost:8787/api/r2

# 上传文本
curl -X PUT http://localhost:8787/api/r2/hello.txt \
  -H "Content-Type: application/json" \
  -d '{"value":"Hello R2!"}'

# 上传文件
curl -X PUT http://localhost:8787/api/r2/photo.jpg \
  -F "file=@/path/to/photo.jpg"

# 下载文件
curl http://localhost:8787/api/r2/hello.txt -o hello.txt

# 获取对象元数据
curl http://localhost:8787/api/r2/hello.txt/metadata

# 删除对象
curl -X DELETE http://localhost:8787/api/r2/hello.txt

# 批量删除
curl -X POST http://localhost:8787/api/r2/delete \
  -H "Content-Type: application/json" \
  -d '{"keys":["file1.txt","file2.jpg"]}'
```

### SQL 执行工具示例
```bash
# 执行查询
curl -X POST http://localhost:8787/api/sql/query -H "Content-Type: application/json" -d "{\"sql\":\"SELECT * FROM sys_user\"}"

# 执行插入
curl -X POST http://localhost:8787/api/sql/query -H "Content-Type: application/json" -d "{\"sql\":\"INSERT INTO sys_user (username, password, nickname) VALUES ('test', '123456', '测试')\"}"

# 执行更新
curl -X POST http://localhost:8787/api/sql/query -H "Content-Type: application/json" -d "{\"sql\":\"UPDATE sys_user SET nickname = '新昵称' WHERE username = 'test\"}"
```

**Web 界面:** 访问 `/system/sql` 使用可视化 SQL 执行工具
**Web 界面:** 访问 `/system/r2` 使用 R2 对象存储管理工具

